<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attune Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen bg-[#0F172A] text-[#F1F5F9] antialiased">
  <main class="mx-auto max-w-2xl px-6 py-10">
    <a href="/?segment=screen" class="text-sm text-[#94A3B8] hover:text-[#F1F5F9]">Back to Attune</a>

    <section class="mt-6 rounded-3xl bg-[#1E293B]/85 p-6 ring-1 ring-[#334155] shadow-xl">
      <p class="text-sm font-semibold uppercase tracking-wide text-[#94A3B8]">Account-first checkout</p>
      <h1 class="mt-2 text-3xl font-semibold">Start your Attune monthly plan</h1>
      <p class="mt-3 text-[#94A3B8]">
        $20/month. Includes 20 urinalysis test strips every month plus unlimited Attune app usage.
      </p>
      <p class="mt-2 text-xs text-[#94A3B8]">
        Shipping details are collected during checkout.
      </p>
    </section>

    <section id="config-warning" class="mt-6 hidden rounded-2xl border border-amber-400/30 bg-amber-500/10 p-4 text-amber-100">
      Missing Supabase web config. Set `window.ATTUNE_SUPABASE_URL` and `window.ATTUNE_SUPABASE_ANON_KEY` in this page, or pass `supabase_url` and `supabase_anon_key` in the URL for local testing.
    </section>

    <section class="mt-6 rounded-3xl bg-[#1E293B]/85 p-6 ring-1 ring-[#334155] shadow-xl space-y-5">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-[#94A3B8]">Step 1</p>
        <h2 class="mt-1 text-xl font-semibold">Create or sign in to your account</h2>
      </div>

      <label class="block">
        <span class="text-sm text-[#94A3B8]">Full name</span>
        <input
          id="name-input"
          type="text"
          autocomplete="name"
          placeholder="Jane Doe"
          class="mt-2 w-full rounded-xl border border-[#334155] bg-[#0F172A]/80 px-4 py-3 text-[#F1F5F9] placeholder:text-[#64748B] focus:border-[#0EA5E9] focus:outline-none focus:ring-2 focus:ring-[#0EA5E9]/40"
        >
      </label>

      <label class="block">
        <span class="text-sm text-[#94A3B8]">Email</span>
        <input
          id="email-input"
          type="email"
          autocomplete="email"
          placeholder="you@example.com"
          class="mt-2 w-full rounded-xl border border-[#334155] bg-[#0F172A]/80 px-4 py-3 text-[#F1F5F9] placeholder:text-[#64748B] focus:border-[#0EA5E9] focus:outline-none focus:ring-2 focus:ring-[#0EA5E9]/40"
        >
      </label>

      <button
        id="send-code-btn"
        class="inline-flex items-center justify-center rounded-full bg-[#0EA5E9] px-6 py-3 text-sm font-semibold text-white shadow transition hover:bg-[#0284C7]"
      >
        Send login code
      </button>

      <div class="rounded-2xl bg-[#0F172A]/70 p-4 ring-1 ring-[#334155]">
        <p class="text-sm text-[#94A3B8]">Enter the code from your email.</p>
        <div class="mt-3 flex flex-col gap-3 sm:flex-row">
          <input
            id="otp-input"
            type="text"
            inputmode="numeric"
            autocomplete="one-time-code"
            placeholder="Code from email"
            class="w-full rounded-xl border border-[#334155] bg-[#0F172A]/80 px-4 py-3 text-[#F1F5F9] placeholder:text-[#64748B] focus:border-[#0EA5E9] focus:outline-none focus:ring-2 focus:ring-[#0EA5E9]/40 sm:w-40"
          >
          <button
            id="verify-btn"
            class="inline-flex items-center justify-center rounded-full bg-white/10 px-5 py-3 text-sm font-semibold text-[#F1F5F9] ring-1 ring-[#334155] transition hover:bg-white/20"
          >
            Verify code
          </button>
        </div>
      </div>

      <div class="rounded-2xl bg-[#0F172A]/70 p-4 ring-1 ring-[#334155]">
        <p class="text-sm font-semibold uppercase tracking-wide text-[#94A3B8]">Step 2</p>
        <h3 class="mt-1 text-lg font-semibold">Continue to secure checkout</h3>
        <p id="account-state" class="mt-2 text-sm text-[#94A3B8]">Sign in first to continue.</p>
        <div class="mt-4 flex flex-wrap gap-3">
          <button
            id="checkout-btn"
            class="inline-flex items-center justify-center rounded-full bg-[#34D399] px-6 py-3 text-sm font-semibold text-[#0F172A] shadow transition hover:bg-[#10B981] disabled:cursor-not-allowed disabled:opacity-50"
            disabled
          >
            Start secure checkout
          </button>
          <button
            id="portal-btn"
            class="inline-flex items-center justify-center rounded-full bg-white/10 px-5 py-3 text-sm font-semibold text-[#F1F5F9] ring-1 ring-[#334155] transition hover:bg-white/20 hidden"
          >
            Manage existing subscription
          </button>
        </div>
      </div>

      <p id="status-text" class="text-sm text-[#94A3B8]"></p>
    </section>
  </main>

  <script>
    const query = new URLSearchParams(window.location.search);
    const LOCAL_URL_KEY = 'attune_supabase_url';
    const LOCAL_ANON_KEY = 'attune_supabase_anon_key';
    const maybeConfigUrl = query.get('supabase_url');
    const maybeConfigAnon = query.get('supabase_anon_key');

    if (maybeConfigUrl) localStorage.setItem(LOCAL_URL_KEY, maybeConfigUrl);
    if (maybeConfigAnon) localStorage.setItem(LOCAL_ANON_KEY, maybeConfigAnon);

    const APP_SUPABASE_URL = 'https://rnpapdvfjepjfoceogjm.supabase.co';
    const APP_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJucGFwZHZmamVwamZvY2VvZ2ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjkwNDQsImV4cCI6MjA4NTU0NTA0NH0.hg4IIk2O4pCA4Ky9xLyOZC1DohUfgYUBnj61JjA8DKs';
    const PROJECT_REF = 'rnpapdvfjepjfoceogjm';
    const AUTH_STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;
    const SUPABASE_URL = window.ATTUNE_SUPABASE_URL || localStorage.getItem(LOCAL_URL_KEY) || APP_SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.ATTUNE_SUPABASE_ANON_KEY || localStorage.getItem(LOCAL_ANON_KEY) || APP_SUPABASE_ANON_KEY;

    const configWarning = document.getElementById('config-warning');
    const nameInput = document.getElementById('name-input');
    const emailInput = document.getElementById('email-input');
    const otpInput = document.getElementById('otp-input');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const verifyBtn = document.getElementById('verify-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    const portalBtn = document.getElementById('portal-btn');
    const statusText = document.getElementById('status-text');
    const accountState = document.getElementById('account-state');

    const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'utm_ad'];
    const pendingEmailState = { value: '' };
    const pendingNameState = { value: '' };
    let supabaseClient = null;
    let currentUser = null;

    const withTimeout = async (promise, timeoutMs, timeoutMessage) => {
      let timeoutId = null;
      const timeoutPromise = new Promise((_, reject) => {
        timeoutId = window.setTimeout(() => reject(new Error(timeoutMessage)), timeoutMs);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        if (timeoutId !== null) {
          window.clearTimeout(timeoutId);
        }
      }
    };

    const setStatus = (message, isError = false) => {
      statusText.textContent = message;
      statusText.classList.toggle('text-rose-300', isError);
      statusText.classList.toggle('text-[#94A3B8]', !isError);
    };

    const formatFunctionError = async (error, functionName) => {
      const raw = String(error?.message || error || '').trim();
      const isReachabilityError = raw.includes('Failed to send a request to the Edge Function');
      if (isReachabilityError) {
        return `Could not reach ${functionName}. This usually means the function is not deployed yet or CORS/secrets are not configured for this Supabase project.`;
      }
      if (error?.status === 401) {
        return 'Your session is not valid. Please send a new code and sign in again.';
      }
      const response = error?.context;
      if (response && typeof response.clone === 'function') {
        try {
          const cloned = response.clone();
          const jsonBody = await cloned.json();
          if (jsonBody?.error) return String(jsonBody.error);
        } catch {
          try {
            const textBody = await response.clone().text();
            if (textBody) return textBody;
          } catch {
            // Ignore parse errors and fall back to default handling.
          }
        }
      }
      if (!raw) return `Could not run ${functionName}.`;
      return raw;
    };

    const invokeEdgeFunction = async (functionName, payload) => {
      const { data: sessionData } = await withTimeout(
        supabaseClient.auth.getSession(),
        10000,
        'Session check timed out.',
      );
      const accessToken = sessionData?.session?.access_token;
      if (!accessToken) {
        throw new Error('Your session is missing. Please sign in again.');
      }

      const response = await withTimeout(
        fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${accessToken}`,
          },
          body: JSON.stringify(payload || {}),
        }),
        20000,
        `${functionName} timed out.`,
      );

      const rawText = await response.text();
      let parsed = null;
      try {
        parsed = rawText ? JSON.parse(rawText) : null;
      } catch {
        parsed = null;
      }

      if (!response.ok) {
        const detail = parsed?.error || parsed?.message || rawText || `HTTP ${response.status}`;
        throw new Error(String(detail));
      }

      return parsed;
    };

    const getCheckoutPayload = () => {
      const payload = {
        segment: 'screen',
        success_url: `${window.location.origin}/purchase-success/?segment=screen`,
        cancel_url: `${window.location.origin}/?segment=screen#waitlist`,
      };

      utmKeys.forEach((key) => {
        const value = query.get(key);
        if (value) payload[key] = value;
      });
      return payload;
    };

    const clearCachedAuthStorage = () => {
      try { localStorage.removeItem(AUTH_STORAGE_KEY); } catch {}
      try { sessionStorage.removeItem(AUTH_STORAGE_KEY); } catch {}
    };

    const requiresFreshSignIn = async (reason) => {
      clearCachedAuthStorage();
      try {
        await supabaseClient.auth.signOut();
      } catch {
        // Ignore sign-out failures and still reset local state.
      }
      currentUser = null;
      await updateSignedInState();
      setStatus(reason || 'Your session expired. Please request a new code and sign in again.', true);
    };

    const updateSignedInState = async () => {
      if (!supabaseClient) return;
      try {
        const { data } = await withTimeout(
          supabaseClient.auth.getSession(),
          10000,
          'Session check timed out.',
        );
        const accessToken = data?.session?.access_token || null;
        if (!accessToken) {
          currentUser = null;
        } else {
          const { data: userData, error: userError } = await withTimeout(
            supabaseClient.auth.getUser(),
            10000,
            'User validation timed out.',
          );
          if (userError || !userData?.user) {
            const userErrorMessage = String(userError?.message || '').toLowerCase();
            if (userErrorMessage.includes('jwt')) {
              clearCachedAuthStorage();
              try { await supabaseClient.auth.signOut(); } catch {}
            }
            currentUser = null;
          } else {
            currentUser = userData.user;
          }
        }
      } catch (error) {
        currentUser = null;
        setStatus(error?.message || 'Could not check session state.', true);
      }

      if (currentUser) {
        accountState.textContent = `Signed in as ${currentUser.email || 'your account'}.`;
        checkoutBtn.disabled = false;
        portalBtn.classList.remove('hidden');
      } else {
        accountState.textContent = 'Sign in first to continue.';
        checkoutBtn.disabled = true;
        portalBtn.classList.add('hidden');
      }
    };

    const waitForSession = async (timeoutMs = 10000) => {
      const startedAt = Date.now();
      while (Date.now() - startedAt < timeoutMs) {
        const { data } = await supabaseClient.auth.getSession();
        if (data?.session?.access_token) {
          const { data: userData, error: userError } = await supabaseClient.auth.getUser();
          if (!userError && userData?.user) {
            currentUser = userData.user;
            return userData.user;
          }
        }
        await new Promise((resolve) => setTimeout(resolve, 250));
      }
      return null;
    };

    const handleSendCode = async () => {
      const fullName = nameInput.value.trim();
      const email = emailInput.value.trim();
      if (!fullName) {
        setStatus('Enter your full name first.', true);
        return;
      }
      if (!email) {
        setStatus('Enter an email address first.', true);
        return;
      }

      setStatus('Sending login code...');
      sendCodeBtn.disabled = true;
      try {
        // Clear any stale session before issuing a fresh OTP challenge.
        clearCachedAuthStorage();
        await supabaseClient.auth.signOut();
        currentUser = null;
        await updateSignedInState();
        const { error } = await supabaseClient.auth.signInWithOtp({
          email,
          options: {
            shouldCreateUser: true,
            data: {
              full_name: fullName,
            },
          },
        });
        if (error) throw error;
        pendingEmailState.value = email;
        pendingNameState.value = fullName;
        setStatus('Code sent. Check your inbox.');
      } catch (error) {
        setStatus(error.message || 'Could not send code.', true);
      } finally {
        sendCodeBtn.disabled = false;
      }
    };

    const handleVerifyCode = async () => {
      const email = pendingEmailState.value || emailInput.value.trim();
      const fullName = pendingNameState.value || nameInput.value.trim();
      const token = otpInput.value.trim();
      if (!email || !token) {
        setStatus('Enter your email and the code.', true);
        return;
      }
      if (!fullName) {
        setStatus('Enter your full name first.', true);
        return;
      }

      if (currentUser && currentUser.email && currentUser.email.toLowerCase() === email.toLowerCase()) {
        setStatus('Already signed in. Redirecting to checkout...');
        await handleStartCheckout();
        return;
      }

      verifyBtn.disabled = true;
      setStatus('Verifying code...');
      try {
        const { error } = await withTimeout(
          supabaseClient.auth.verifyOtp({
            email,
            token,
            type: 'email',
          }),
          15000,
          'Code verification timed out. Please try again.',
        );
        if (error) throw error;
        setStatus('Verified. Finalizing sign-in...');
        const sessionUser = await waitForSession(10000);
        if (!sessionUser) {
          throw new Error('Sign-in did not complete. Please request a new code and try again.');
        }
        await updateSignedInState();
        if (!currentUser) {
          throw new Error('Code verified but login session was not established. Click "Start secure checkout" after refresh.');
        }
        setStatus('Signed in. Redirecting to checkout...');
        await handleStartCheckout();
      } catch (error) {
        setStatus(error.message || 'Code verification failed.', true);
      } finally {
        verifyBtn.disabled = false;
      }
    };

    const handleStartCheckout = async () => {
      await updateSignedInState();
      if (!currentUser) {
        setStatus('Sign in first to start checkout.', true);
        checkoutBtn.disabled = true;
        return;
      }

      checkoutBtn.disabled = true;
      setStatus('Creating secure checkout session...');
      try {
        const data = await invokeEdgeFunction('stripe-create-checkout', getCheckoutPayload());
        if (!data?.url) throw new Error('Checkout URL was not returned.');
        window.location.href = data.url;
      } catch (error) {
        const message = await formatFunctionError(error, 'stripe-create-checkout');
        if (message.toLowerCase().includes('invalid jwt')) {
          await requiresFreshSignIn('Session token is invalid. Please click "Send login code" and verify again.');
          return;
        }
        setStatus(message, true);
        checkoutBtn.disabled = !currentUser;
      }
    };

    const handleManageSubscription = async () => {
      if (!currentUser) return;
      portalBtn.disabled = true;
      setStatus('Opening billing portal...');
      try {
        const data = await invokeEdgeFunction('stripe-create-portal', {
          return_url: `${window.location.origin}/purchase-success/?segment=screen`,
        });
        if (!data?.url) throw new Error('Portal URL was not returned.');
        window.location.href = data.url;
      } catch (error) {
        const message = await formatFunctionError(error, 'stripe-create-portal');
        if (message.toLowerCase().includes('invalid jwt')) {
          await requiresFreshSignIn('Session token is invalid. Please click "Send login code" and verify again.');
          portalBtn.disabled = false;
          return;
        }
        setStatus(message, true);
        portalBtn.disabled = false;
      }
    };

    const init = async () => {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        configWarning.classList.remove('hidden');
        sendCodeBtn.disabled = true;
        verifyBtn.disabled = true;
        checkoutBtn.disabled = true;
        return;
      }

      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      await updateSignedInState();
      supabaseClient.auth.onAuthStateChange(async () => {
        await updateSignedInState();
      });
    };

    sendCodeBtn.addEventListener('click', handleSendCode);
    verifyBtn.addEventListener('click', handleVerifyCode);
    checkoutBtn.addEventListener('click', handleStartCheckout);
    portalBtn.addEventListener('click', handleManageSubscription);
    init();
  </script>
</body>
</html>
